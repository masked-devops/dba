<?xml version="1.0" encoding="UTF-8" ?>
<displays>
<display id="b9c485d8-016c-1000-8015-0b0e12974065" type="" style="Chart" enable="true">
	<name><![CDATA[masked-devops Session History]]></name>
	<description><![CDATA[Active session hiistory report]]></description>
	<tooltip><![CDATA[11g]]></tooltip>
	<drillclass><![CDATA[]]></drillclass>
	<CustomValues>
		<Y1AXIS_TITLE_TEXT><![CDATA[Active Sessions]]></Y1AXIS_TITLE_TEXT>
		<PLOT_HGRID_WIDTH><![CDATA[THINNER]]></PLOT_HGRID_WIDTH>
		<PLOT_DATATIPS_CUMULATIVE_VALUE><![CDATA[false]]></PLOT_DATATIPS_CUMULATIVE_VALUE>
		<XAXIS_TICK_LABEL_AUTO_ROTATE><![CDATA[true]]></XAXIS_TICK_LABEL_AUTO_ROTATE>
		<Y1AXIS_SCALE_INCREMENT><![CDATA[1.0]]></Y1AXIS_SCALE_INCREMENT>
		<Y2AXIS_SCALE_MAXIMUM><![CDATA[60.0]]></Y2AXIS_SCALE_MAXIMUM>
		<Y1AXIS_LINE_WIDTH><![CDATA[THINNEST]]></Y1AXIS_LINE_WIDTH>
		<PLOT_SERIES_OPTIONS_FITLINE_TYPE><![CDATA[\,NONE,NONE,NONE,NONE,NONE]]></PLOT_SERIES_OPTIONS_FITLINE_TYPE>
		<Y1AXIS_TITLE_ALIGNMENT><![CDATA[CENTER]]></Y1AXIS_TITLE_ALIGNMENT>
		<LEGEND_LOCATION><![CDATA[AUTOMATIC]]></LEGEND_LOCATION>
		<LEGEND_ALIGNMENT><![CDATA[LEFT]]></LEGEND_ALIGNMENT>
		<GRADIENT><![CDATA[false]]></GRADIENT>
		<XAXIS_LINE_WIDTH><![CDATA[THINNEST]]></XAXIS_LINE_WIDTH>
		<LEGEND><![CDATA[true]]></LEGEND>
		<FOOTNOTE><![CDATA[false]]></FOOTNOTE>
		<Y1AXIS_SCALE_MAXIMUM><![CDATA[180.0]]></Y1AXIS_SCALE_MAXIMUM>
		<XAXIS_TITLE_ALIGNMENT><![CDATA[CENTER]]></XAXIS_TITLE_ALIGNMENT>
		<Y1AXIS_SCALE_INCREMENT_AUTOMATIC><![CDATA[false]]></Y1AXIS_SCALE_INCREMENT_AUTOMATIC>
		<XAXIS_LOGARITHMIC_BASE><![CDATA[BASE_10]]></XAXIS_LOGARITHMIC_BASE>
		<XAXIS_TICK_LABEL_ROTATE><![CDATA[HORIZONTAL]]></XAXIS_TICK_LABEL_ROTATE>
		<Y1AXIS_LOGARITHMIC_BASE><![CDATA[BASE_10]]></Y1AXIS_LOGARITHMIC_BASE>
		<TYPE><![CDATA[BAR_VERT_STACK]]></TYPE>
		<GRID_WIDTH><![CDATA[THINNER]]></GRID_WIDTH>
		<PLOT_DATALABELS_BAR_POSITION><![CDATA[ABOVE]]></PLOT_DATALABELS_BAR_POSITION>
		<FOOTNOTE_ALIGNMENT><![CDATA[LEFT]]></FOOTNOTE_ALIGNMENT>
		<XAXIS_TICK_LABEL_SKIP_MODE><![CDATA[AUTOMATIC]]></XAXIS_TICK_LABEL_SKIP_MODE>
		<Y2AXIS_LOGARITHMIC_BASE><![CDATA[BASE_10]]></Y2AXIS_LOGARITHMIC_BASE>
		<GRID><![CDATA[true]]></GRID>
		<STYLE><![CDATA[Regatta]]></STYLE>
		<TITLE_ALIGNMENT><![CDATA[LEFT]]></TITLE_ALIGNMENT>
		<XAXIS_SCALE_INCREMENT><![CDATA[10.0]]></XAXIS_SCALE_INCREMENT>
		<XAXIS_SCALE_MAXIMUM><![CDATA[70.0]]></XAXIS_SCALE_MAXIMUM>
		<Y1AXIS_SCALE_MINIMUM_AUTOMATIC><![CDATA[false]]></Y1AXIS_SCALE_MINIMUM_AUTOMATIC>
		<Y2AXIS_TICK_LABEL_ROTATE><![CDATA[HORIZONTAL]]></Y2AXIS_TICK_LABEL_ROTATE>
		<Y2AXIS_SCALE_MINIMUM><![CDATA[10.0]]></Y2AXIS_SCALE_MINIMUM>
		<XAXIS_TITLE><![CDATA[true]]></XAXIS_TITLE>
		<THREED><![CDATA[false]]></THREED>
		<Y2AXIS_LINE_WIDTH><![CDATA[THINNEST]]></Y2AXIS_LINE_WIDTH>
		<Y1AXIS_TICK_LABEL_ROTATE><![CDATA[HORIZONTAL]]></Y1AXIS_TICK_LABEL_ROTATE>
		<Y1AXIS_TITLE><![CDATA[true]]></Y1AXIS_TITLE>
		<Y2AXIS_SCALE_INCREMENT><![CDATA[10.0]]></Y2AXIS_SCALE_INCREMENT>
		<PLOT_VGRID_WIDTH><![CDATA[THINNER]]></PLOT_VGRID_WIDTH>
		<Y2AXIS_TITLE_ALIGNMENT><![CDATA[CENTER]]></Y2AXIS_TITLE_ALIGNMENT>
		<XAXIS_TITLE_TEXT><![CDATA[Time]]></XAXIS_TITLE_TEXT>
		<SUBTITLE_ALIGNMENT><![CDATA[LEFT]]></SUBTITLE_ALIGNMENT>
	</CustomValues>
	<query>
		<sql><![CDATA[-- -----------------------------------------------------------------------------
-- Author      : Masked DevOps
-- Date        : Jan 2012
-- Version     : 0.1
-- -----------------------------------------------------------------------------
with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
    ,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
    ,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash as    (select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select cast(start_date as timestamp) start_date, cast(end_date as timestamp) end_date, sample_source from parms) p, snaps where p.sample_source=10 and snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time >= start_date and sample_time <= end_date union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select cast(start_date as timestamp) start_date, cast(end_date as timestamp) end_date, sample_source from parms) p        where p.sample_source=1  and sample_time >= start_date and sample_time <= end_date )
    ,hist as (  select
                     sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 sample_time_ft
                    ,case
                        when lower(parms.dim) = 'instance_number'       then to_char(ash.instance_number)
                        when lower(parms.dim) = 'user_id'               then to_char(ash.user_id)
                        when lower(parms.dim) = 'session_sid'           then ash.session_id||'.'||ash.session_serial#
                        when lower(parms.dim) = 'xid'                   then rawtohex(ash.xid)
                        when lower(parms.dim) = 'sql_exec_id'           then to_char(ash.sql_exec_id)
                        when lower(parms.dim) = 'sql_exec_id_plan'      then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)
                        when lower(parms.dim) = 'sql_exec_id_plan_oper' then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)||'.'||to_char(ash.sql_plan_line_id)||'.'||ash.sql_plan_operation||'.'||ash.sql_plan_options
                        when lower(parms.dim) = 'sql_id'                then ash.sql_id
                        when lower(parms.dim) = 'current_obj#'          then to_char(ash.current_obj#)
                        when lower(parms.dim) = 'module'                then ash.module
                        when lower(parms.dim) = 'program'               then ash.program
                        when lower(parms.dim) = 'action'                then ash.action
                        when lower(parms.dim) = 'machine'               then ash.machine
                        when lower(parms.dim) = 'event'                 then ash.event
                        when lower(parms.dim) = 'wait_class'            then case when session_state = 'ON CPU'  then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
                        else                                            case when session_state = 'ON CPU'   then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
                    end dim 
                from ash cross join parms
                where 1=1
                    ------- additional filters
                    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
                    and ash.session_id      = nvl(parms.session_id, ash.session_id)
                    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
                    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
                    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)
                    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
                    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
                    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
                    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
                    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)

        )
select
     to_char(slots.slot,'yyyy-mm-dd hh24:mi:ss') slot
    ,hist.dim
    ,count(hist.dim)*sample_source/inter active_sessions
from slots,hist,parms
where slots.slot = hist.sample_time_ft(+)
group by slots.slot, hist.dim,inter,sample_source
order by slots.slot,hist.dim]]></sql>
		<binds>
			<bind id="p_start_date">
				<prompt><![CDATA[start_date]]></prompt>
				<tooltip><![CDATA[yyyy-mm-dd hh24:mi]]></tooltip>
				<value><![CDATA[2019-10-11 ]]></value>
				<bracket><![CDATA[null]]></bracket>
			</bind>
			<bind id="p_end_date">
				<prompt><![CDATA[end_date]]></prompt>
				<tooltip><![CDATA[yyyy-mm-dd hh24:mi]]></tooltip>
				<value><![CDATA[NULL_VALUE]]></value>
				<bracket><![CDATA[null]]></bracket>
			</bind>
			<bind id="p_interval">
				<prompt><![CDATA[interval in seconds]]></prompt>
				<tooltip><![CDATA[time slot in seconds]]></tooltip>
				<value><![CDATA[600]]></value>
				<bracket><![CDATA[null]]></bracket>
			</bind>
			<bind id="p_dim">
				<prompt><![CDATA[dimension]]></prompt>
				<tooltip><![CDATA[instance_number|user_id|session_sid|xid|sql_exec_id|sql_exec_id_plan|sql_exec_id_plan_oper|sql_id|current_obj#|module|program|action|machine|event|wait_class]]></tooltip>
				<value><![CDATA[NULL_VALUE]]></value>
				<bracket><![CDATA[null]]></bracket>
			</bind>
			<bind id="P_INST_ID">
				<prompt><![CDATA[INST_ID]]></prompt>
				<tooltip><![CDATA[INSTANCE NUMBER]]></tooltip>
				<value><![CDATA[NULL_VALUE]]></value>
				<bracket><![CDATA[null]]></bracket>
			</bind>
			<bind id="P_SESSION_SID">
				<prompt><![CDATA[SESSION_SID]]></prompt>
				<tooltip><![CDATA[SESSION_SID]]></tooltip>
				<value><![CDATA[NULL_VALUE]]></value>
				<bracket><![CDATA[null]]></bracket>
			</bind>
			<bind id="P_SESSION_SERIAL#">
				<prompt><![CDATA[SESSION_SERIAL#]]></prompt>
				<tooltip><![CDATA[SESSION_SERIAL#]]></tooltip>
				<value><![CDATA[NULL_VALUE]]></value>
				<bracket><![CDATA[null]]></bracket>
			</bind>
			<bind id="P_SQL_ID">
				<prompt><![CDATA[SQL_ID]]></prompt>
				<tooltip><![CDATA[SQL_ID]]></tooltip>
				<value><![CDATA[NULL_VALUE]]></value>
				<bracket><![CDATA[null]]></bracket>
			</bind>
			<bind id="P_SESSION_TYPE">
				<prompt><![CDATA[SESSION_TYPE]]></prompt>
				<tooltip><![CDATA[FOREGROUND/BACKGROUND]]></tooltip>
				<value><![CDATA[NULL_VALUE]]></value>
				<bracket><![CDATA[null]]></bracket>
			</bind>
			<bind id="P_USER_ID">
				<prompt><![CDATA[USER_ID]]></prompt>
				<tooltip><![CDATA[USER_ID]]></tooltip>
				<value><![CDATA[NULL_VALUE]]></value>
				<bracket><![CDATA[null]]></bracket>
			</bind>
			<bind id="P_MODULE">
				<prompt><![CDATA[MODULE]]></prompt>
				<tooltip><![CDATA[MODULE]]></tooltip>
				<value><![CDATA[NULL_VALUE]]></value>
				<bracket><![CDATA[null]]></bracket>
			</bind>
			<bind id="P_PROGRAM">
				<prompt><![CDATA[PROGRAM]]></prompt>
				<tooltip><![CDATA[PROGRAM]]></tooltip>
				<value><![CDATA[NULL_VALUE]]></value>
				<bracket><![CDATA[null]]></bracket>
			</bind>
			<bind id="P_MACHINE">
				<prompt><![CDATA[MACHINE]]></prompt>
				<tooltip><![CDATA[MACHINE]]></tooltip>
				<value><![CDATA[NULL_VALUE]]></value>
				<bracket><![CDATA[null]]></bracket>
			</bind>
			<bind id="P_WAIT_CLASS">
				<prompt><![CDATA[P_WAIT_CLASS]]></prompt>
				<tooltip><![CDATA[P_WAIT_CLASS]]></tooltip>
				<value><![CDATA[NULL_VALUE]]></value>
				<bracket><![CDATA[null]]></bracket>
			</bind>
		</binds>
	</query>
		<pdf version="VERSION_1_7" compression="CONTENT">
			<docproperty title="" author="" subject="" keywords="" />
			<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
			<column>
				<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
				<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
				<blob blob="NONE" zip="false" />
			</column>
			<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
			<header enable="false" generatedate="false">
				<data>
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
					
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
					
					
					
					
					
					
					
				null																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												</data>
			</header>
			<footer enable="false" generatedate="false">
				<data value="null" />
			</footer>
			<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
		</pdf>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Report Parms]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
	,ash   as (select /*+ materialize */ 
                     ash.*
                    ,parms.inter 
                    ,count(*)                       over ()  cnt_tot
                    ,count(distinct ash.session_id) over ()  cnt_sid
                    ,count(distinct ash.sql_id)     over ()  cnt_sql_id
                    ,count(distinct sql_exec_id)    over ()  cnt_exec_id
                from ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                       select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end
                     ) ash ,parms)
select 'start_date' parameter   , to_char(start_date,'yyyy-mm-dd hh24:mi')     value                          ,'----','sample source              ' info     ,case when sample_source = 1 then 'v$active_session_history' else 'dba_hist_active_sess_history' end info_value from parms  union all
select 'end_date                ',to_char(end_date,'yyyy-mm-dd hh24:mi')                                      ,'----','cpu count                  '          ,(select sp.value from v$parameter sp  where name = 'cpu_count')                                                from parms  union all
select 'dim                     ',dim                                                                         ,'----','memory_target              '          ,(select sp.value from v$parameter sp  where name = 'memory_target')                                            from parms  union all
select 'inter                   ',to_char(parms.inter)                                                        ,'----','memory_max_target          '          ,(select sp.value from v$parameter sp  where name = 'memory_max_target')                                        from parms  union all
select 'start slot              ',to_char(cast(:SLOT as date),'yyyy-mm-dd hh24:mi:ss')                        ,'----','sga_target                 '          ,(select sp.value from v$parameter sp  where name = 'sga_target')                                               from parms  union all
select 'end   slot              ',to_char(cast(:SLOT as date)+ parms.inter/24/60/60 ,'yyyy-mm-dd hh24:mi:ss') ,'----','sga_max_target             '          ,(select sp.value from v$parameter sp  where name = 'sga_max_target')                                           from parms  union all
select 'instance_number         ',to_char(parms.instance_number)                                              ,'----','pga_aggregate_target       '          ,(select sp.value from v$parameter sp  where name = 'pga_aggregate_target')                                     from parms  union all
select 'session_id              ',to_char(parms.session_id)                                                   ,'----','samples                    '          ,(select to_char(cnt_tot)        from ash where rownum < 2)                                                     from parms union all
select 'session_serial#         ',to_char(parms.session_serial#)                                              ,'----','sessions                   '          ,(select to_char(cnt_sid)        from ash where rownum < 2)                                                     from parms union all
select 'sql_id                  ',parms.sql_id                                                                ,'----','distinct sql count         '          ,(select to_char(cnt_sql_id)     from ash where rownum < 2)                                                     from parms union all
select 'session_type            ',parms.session_type                                                          ,'----','exec_id                    '          ,(select to_char(cnt_exec_id)    from ash where rownum < 2)                                                     from parms union all
select 'user_id                 ',to_char(parms.user_id)                                                      ,'----','                           '          ,null                            from parms union all    
select 'module                  ',parms.module                                                                ,'----','                           '          ,null                            from parms union all    
select 'program                 ',parms.program                                                               ,'----','                           '          ,null                            from parms union all    
select 'machine                 ',parms.machine                                                               ,'----','                           '          ,null                            from parms union all    
select 'wait_class              ',parms.wait_class                                                            ,'----','                           '          ,null                            from parms union all    
select '----','----','----','----','----' from dual]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
						
						
						
						
						
						
					null																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																												</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Top dim/event]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select distinct
	 :DIM dim
	,ash.event
	,round(sum(ash.time_waited)  over (partition by :DIM,ash.event)/1000)   total_wait_time_ms 
	,round(avg(ash.time_waited)  over (partition by :DIM,ash.event)/1000,2) avg_wait_time_ms 
	,count(ash.sample_id)        over (partition by :DIM,ash.event)         cnt_event
	,count(*) over ()                                                       cnt_ash
	,case  when count(*) over ()=0 then 0 else trunc(count(ash.sample_id) over (partition by :DIM,ash.event)/count(*) over ()*100) end load_pct
from ash
	left outer join dba_users users			on ash.user_id = users.user_id
	cross join parms
where 1=1
	------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
	and :DIM =	case
                    when lower(parms.dim) = 'instance_number'       then to_char(ash.instance_number)
                    when lower(parms.dim) = 'user_id'               then to_char(ash.user_id)
                    when lower(parms.dim) = 'session_sid'           then ash.session_id||'.'||ash.session_serial#
                    when lower(parms.dim) = 'xid'                   then rawtohex(ash.xid)
                    when lower(parms.dim) = 'sql_exec_id'           then to_char(ash.sql_exec_id)
                    when lower(parms.dim) = 'sql_exec_id_plan'      then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)
                    when lower(parms.dim) = 'sql_exec_id_plan_oper' then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)||'.'||to_char(ash.sql_plan_line_id)||'.'||ash.sql_plan_operation||'.'||ash.sql_plan_options
                    when lower(parms.dim) = 'sql_id'                then ash.sql_id
                    when lower(parms.dim) = 'current_obj#'          then to_char(ash.current_obj#)
                    when lower(parms.dim) = 'module'                then ash.module
                    when lower(parms.dim) = 'program'               then ash.program
                    when lower(parms.dim) = 'action'                then ash.action
                    when lower(parms.dim) = 'machine'               then ash.machine
                    when lower(parms.dim) = 'event'                 then ash.event
                    when lower(parms.dim) = 'wait_class'            then case when session_state = 'ON CPU'  then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
                    else                                            case when session_state = 'ON CPU'   then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
				end
order by cnt_event desc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
						
						
						
						
						
						
					null																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																													</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Sessions all]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select
    --ash.sample_id
    to_char(ash.sample_time,'yyyy-mm-dd hh24:mi:ss') sample_time
    --,ash.is_awr_sample
    ,ash.session_id       sid
    ,ash.session_serial#  serial#
    ,ash.sql_id
    ,ash.sql_plan_hash_value
    ,ash.xid
    ,ash.sql_exec_id
    ,to_char(ash.sql_exec_start,'yyyy-mm-dd hh24:mi:ss')	 sql_exec_start
    ,ash.session_type
    --,ash.flags
    --,u.username
    ,'SQLDEV:LINK:'||USER||':USER:'||u.username||':oracle.dbtools.raptor.dba.navigator.Drill.DBADrillLink' username
    --,ash.user_id
    --,ash.is_sqlid_current
    --,ash.sql_child_number
    ,ash.wait_class
    ,ash.event
    --,ash.sql_opcode
    ,ash.sql_opname
    --,ash.force_matching_signature
    ,ash.top_level_sql_id
    --,ash.top_level_sql_opcode
    ,ash.sql_plan_line_id
    ,ash.sql_plan_operation
    ,ash.sql_plan_options
    ,ash.plsql_entry_object_id
    ,ash.plsql_entry_subprogram_id
    ,ash.plsql_object_id
    ,ash.plsql_subprogram_id
    --,ash.qc_instance_id
    ,ash.qc_session_id
    ,ash.qc_session_serial#
    --,ash.px_flags
    --,ash.event
    --,ash.event_id
    ,ash.seq#
    ,ash.p1text
    ,ash.p1
    ,ash.p2text
    ,ash.p2
    ,ash.p3text
    ,ash.p3
    --,ash.wait_class
    --,ash.wait_class_id
    ,ash.wait_time
    ,ash.session_state
    ,ash.time_waited
    ,ash.blocking_session_status
    ,ash.blocking_session
    ,ash.blocking_session_serial#
    ,ash.blocking_inst_id
    ,ash.blocking_hangchain_info
    ,o.owner||'.'||o.object_name||'  '||o.subobject_name||'('||o.object_type||')' object
    ,'SQLDEV:LINK:'||owner||':'||o.object_type||':'||o.object_name||':oracle.dbtools.raptor.controls.grid.DefaultDrillLink' link
    ,f.name datafile
    --,ash.current_obj#
    --,ash.current_file#
    ,ash.current_block#
    ,ash.current_row#
    --,ash.top_level_call#
    ,ash.top_level_call_name
    ,ash.consumer_group_id
    ,ash.remote_instance#
    --,ash.time_model
    --,ash.in_connection_mgmt
    --,ash.in_parse
    --,ash.in_hard_parse
    --,ash.in_sql_execution
    --,ash.in_plsql_execution
    --,ash.in_plsql_rpc
    --,ash.in_plsql_compilation
    --,ash.in_java_execution
    --,ash.in_bind
    --,ash.in_cursor_close
    --,ash.in_sequence_load
    --,ash.capture_overhead
    --,ash.replay_overhead
    --,ash.is_captured
    --,ash.is_replayed
    --,ash.service_hash
    ,ash.program
    ,ash.module
    ,ash.action
    ,ash.client_id
    ,ash.machine
    ,ash.port
    ,ash.ecid
    --,ash.dbreplay_file_id
    --,ash.dbreplay_call_counter
    --,ash.tm_delta_time
    --,ash.tm_delta_cpu_time
    --,ash.tm_delta_db_time
    --,ash.delta_time
    --,ash.delta_read_io_requests
    --,ash.delta_write_io_requests
    --,ash.delta_read_io_bytes
    --,ash.delta_write_io_bytes
    --,ash.delta_interconnect_io_bytes
    ,ash.pga_allocated
    ,ash.temp_space_allocated
    ,nvl((select dbms_lob.substr(sql_fulltext,1000) from gv$sqlstats sqlt where sqlt.sql_id = ash.sql_id and rownum < 2),(select dbms_lob.substr(sql_text,1000) from dba_hist_sqltext hs where hs.sql_id = ash.sql_id and rownum < 2)) sql_fulltext
from ash
		cross join	parms
		left  outer join dba_users u		on ash.user_id = u.user_id
		left  outer join gv$event_name e	on ash.instance_number = e.inst_id and ash.event_id = e.event_id
		left  outer join dba_objects o      on ash.current_obj# = o.object_id
		left  outer join gv$datafile f		on ash.instance_number = f.inst_id and ash.current_file# = f.file#
where 1=1
    ------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
order by sample_time asc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
						
						
						
						
						
						
					null																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Top Sessions]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select distinct
	 ash.session_id       sid
	,ash.session_serial#  serial#
	,users.username
	,ash.machine
	,ash.program
	,ash.module
	,count(ash.session_id)  over (partition by ash.session_id,ash.session_serial#)  cnt_sid
	,count(*)               over ()  cnt_ash
	,case  when count(*)    over ()=0 then 0 else trunc(count(ash.session_id) over (partition by ash.session_id,ash.session_serial#)/count(*) over ()*100) end load_pct
from ash
	left outer join dba_users users			on ash.user_id = users.user_id
	cross join parms
where 1=1
	------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
order by load_pct desc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
						
						
						
						
						
						
						null																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																		</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Sessions by dim]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select
	 :DIM dim
    --ash.sample_id
    ,to_char(ash.sample_time,'yyyy-mm-dd hh24:mi:ss') sample_time
    --,ash.is_awr_sample
    ,ash.session_id       sid
    ,ash.session_serial#  serial#
    ,ash.sql_id
    ,ash.sql_plan_hash_value
    ,ash.xid
    ,ash.sql_exec_id
    ,to_char(ash.sql_exec_start,'yyyy-mm-dd hh24:mi:ss')	 sql_exec_start
    ,ash.session_type
    --,ash.flags
    --,u.username
    ,'SQLDEV:LINK:'||USER||':USER:'||u.username||':oracle.dbtools.raptor.dba.navigator.Drill.DBADrillLink' username
    --,ash.user_id
    --,ash.is_sqlid_current
    --,ash.sql_child_number
    ,ash.wait_class
    ,ash.event
    --,ash.sql_opcode
    ,ash.sql_opname
    --,ash.force_matching_signature
    ,ash.top_level_sql_id
    --,ash.top_level_sql_opcode
    ,ash.sql_plan_line_id
    ,ash.sql_plan_operation
    ,ash.sql_plan_options
    ,ash.plsql_entry_object_id
    ,ash.plsql_entry_subprogram_id
    ,ash.plsql_object_id
    ,ash.plsql_subprogram_id
    --,ash.qc_instance_id
    ,ash.qc_session_id
    ,ash.qc_session_serial#
    --,ash.px_flags
    --,ash.event
    --,ash.event_id
    ,ash.seq#
    ,ash.p1text
    ,ash.p1
    ,ash.p2text
    ,ash.p2
    ,ash.p3text
    ,ash.p3
    --,ash.wait_class
    --,ash.wait_class_id
    ,ash.wait_time
    ,ash.session_state
    ,ash.time_waited
    ,ash.blocking_session_status
    ,ash.blocking_session
    ,ash.blocking_session_serial#
    ,ash.blocking_inst_id
    ,ash.blocking_hangchain_info
    ,o.owner||'.'||o.object_name||'  '||o.subobject_name||'('||o.object_type||')' object
    ,'SQLDEV:LINK:'||owner||':'||o.object_type||':'||o.object_name||':oracle.dbtools.raptor.controls.grid.DefaultDrillLink' link
    ,f.name datafile
    --,ash.current_obj#
    --,ash.current_file#
    ,ash.current_block#
    ,ash.current_row#
    --,ash.top_level_call#
    ,ash.top_level_call_name
    ,ash.consumer_group_id
    ,ash.remote_instance#
    --,ash.time_model
    --,ash.in_connection_mgmt
    --,ash.in_parse
    --,ash.in_hard_parse
    --,ash.in_sql_execution
    --,ash.in_plsql_execution
    --,ash.in_plsql_rpc
    --,ash.in_plsql_compilation
    --,ash.in_java_execution
    --,ash.in_bind
    --,ash.in_cursor_close
    --,ash.in_sequence_load
    --,ash.capture_overhead
    --,ash.replay_overhead
    --,ash.is_captured
    --,ash.is_replayed
    --,ash.service_hash
    ,ash.program
    ,ash.module
    ,ash.action
    ,ash.client_id
    ,ash.machine
    ,ash.port
    ,ash.ecid
    --,ash.dbreplay_file_id
    --,ash.dbreplay_call_counter
    --,ash.tm_delta_time
    --,ash.tm_delta_cpu_time
    --,ash.tm_delta_db_time
    --,ash.delta_time
    --,ash.delta_read_io_requests
    --,ash.delta_write_io_requests
    --,ash.delta_read_io_bytes
    --,ash.delta_write_io_bytes
    --,ash.delta_interconnect_io_bytes
    ,ash.pga_allocated
    ,ash.temp_space_allocated
    ,nvl((select dbms_lob.substr(sql_fulltext,1000) from gv$sqlstats sqlt where sqlt.sql_id = ash.sql_id and rownum < 2),(select dbms_lob.substr(sql_text,1000) from dba_hist_sqltext hs where hs.sql_id = ash.sql_id and rownum < 2)) sql_fulltext
from ash
    cross join	parms
    left  outer join dba_users u		on ash.user_id = u.user_id
    left  outer join gv$event_name e	on ash.instance_number = e.inst_id and ash.event_id = e.event_id
    left  outer join dba_objects o		on ash.current_obj# = o.object_id
    left  outer join gv$datafile f		on ash.instance_number = f.inst_id and ash.current_file# = f.file#
where 1=1
	------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
    and :DIM =	case
                    when lower(parms.dim) = 'instance_number'       then to_char(ash.instance_number)
                    when lower(parms.dim) = 'user_id'               then to_char(ash.user_id)
                    when lower(parms.dim) = 'session_sid'           then ash.session_id||'.'||ash.session_serial#
                    when lower(parms.dim) = 'xid'                   then rawtohex(ash.xid)
                    when lower(parms.dim) = 'sql_exec_id'           then to_char(ash.sql_exec_id)
                    when lower(parms.dim) = 'sql_exec_id_plan'      then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)
                    when lower(parms.dim) = 'sql_exec_id_plan_oper' then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)||'.'||to_char(ash.sql_plan_line_id)||'.'||ash.sql_plan_operation||'.'||ash.sql_plan_options
                    when lower(parms.dim) = 'sql_id'                then ash.sql_id
                    when lower(parms.dim) = 'current_obj#'          then to_char(ash.current_obj#)
                    when lower(parms.dim) = 'module'                then ash.module
                    when lower(parms.dim) = 'program'               then ash.program
                    when lower(parms.dim) = 'action'                then ash.action
                    when lower(parms.dim) = 'machine'               then ash.machine
                    when lower(parms.dim) = 'event'                 then ash.event
                    when lower(parms.dim) = 'wait_class'            then case when session_state = 'ON CPU'  then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
                    else                                            case when session_state = 'ON CPU'   then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
                end
order by sample_time asc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
						
						
						
						
						
						
					null																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Top Sessions by dim]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select distinct
	 :DIM dim
	,ash.session_id         sid
	,ash.session_serial#    serial#
	--,users.username
    ,'SQLDEV:LINK:'||USER||':USER:'||users.username||':oracle.dbtools.raptor.dba.navigator.Drill.DBADrillLink' username
	,ash.machine
	,ash.program
	,ash.module
	,count(ash.session_id)  over (partition by ash.session_id,ash.session_serial#)  cnt_sid
	,count(*)               over ()  cnt_ash
	,case  when count(*)    over ()=0 then 0 else trunc(count(ash.session_id) over (partition by ash.session_id,ash.session_serial#)/count(*) over ()*100) end load_pct
from ash
	left outer join dba_users users			on ash.user_id = users.user_id
	cross join parms
where 1=1
	------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
	and :DIM =	case
                    when lower(parms.dim) = 'instance_number'       then to_char(ash.instance_number)
                    when lower(parms.dim) = 'user_id'               then to_char(ash.user_id)
                    when lower(parms.dim) = 'session_sid'           then ash.session_id||'.'||ash.session_serial#
                    when lower(parms.dim) = 'xid'                   then rawtohex(ash.xid)
                    when lower(parms.dim) = 'sql_exec_id'           then to_char(ash.sql_exec_id)
                    when lower(parms.dim) = 'sql_exec_id_plan'      then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)
                    when lower(parms.dim) = 'sql_exec_id_plan_oper' then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)||'.'||to_char(ash.sql_plan_line_id)||'.'||ash.sql_plan_operation||'.'||ash.sql_plan_options
                    when lower(parms.dim) = 'sql_id'                then ash.sql_id
                    when lower(parms.dim) = 'current_obj#'          then to_char(ash.current_obj#)
                    when lower(parms.dim) = 'module'                then ash.module
                    when lower(parms.dim) = 'program'               then ash.program
                    when lower(parms.dim) = 'action'                then ash.action
                    when lower(parms.dim) = 'machine'               then ash.machine
                    when lower(parms.dim) = 'event'                 then ash.event
                    when lower(parms.dim) = 'wait_class'            then case when session_state = 'ON CPU'  then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
                    else                                            case when session_state = 'ON CPU'   then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
				end
order by cnt_sid desc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
						
						
						
						
						
						
						null																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																		</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Top Sessions by dim/event]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select distinct
	 :DIM dim
	,ash.event
	,ash.session_id         sid
	,ash.session_serial#    serial#
	--,users.username
    ,'SQLDEV:LINK:'||USER||':USER:'||users.username||':oracle.dbtools.raptor.dba.navigator.Drill.DBADrillLink' username
	,ash.machine
	,ash.program
	,ash.module
	,round(sum(ash.time_waited)  over (partition by ash.session_id,ash.session_serial#,ash.event)/1000)     total_wait_time_ms 
	,round(avg(ash.time_waited)  over (partition by ash.session_id,ash.session_serial#,ash.event)/1000,2)   avg_wait_time_ms 
	,count(ash.session_id)  over (partition by ash.session_id,ash.session_serial#,ash.event)	            cnt_sid
	,count(*)               over ()                                                                         cnt_ash
	,case  when count(*)    over ()=0 then 0 else trunc(count(ash.session_id) over (partition by ash.session_id,ash.session_serial#,ash.event)/count(*) over ()*100) end load_pct
from ash
	left outer join dba_users users			on ash.user_id = users.user_id
	cross join parms
where 1=1
	------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
	and :DIM =	case
                    when lower(parms.dim) = 'instance_number'       then to_char(ash.instance_number)
                    when lower(parms.dim) = 'user_id'               then to_char(ash.user_id)
                    when lower(parms.dim) = 'session_sid'           then ash.session_id||'.'||ash.session_serial#
                    when lower(parms.dim) = 'xid'                   then rawtohex(ash.xid)
                    when lower(parms.dim) = 'sql_exec_id'           then to_char(ash.sql_exec_id)
                    when lower(parms.dim) = 'sql_exec_id_plan'      then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)
                    when lower(parms.dim) = 'sql_exec_id_plan_oper' then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)||'.'||to_char(ash.sql_plan_line_id)||'.'||ash.sql_plan_operation||'.'||ash.sql_plan_options
                    when lower(parms.dim) = 'sql_id'                then ash.sql_id
                    when lower(parms.dim) = 'current_obj#'          then to_char(ash.current_obj#)
                    when lower(parms.dim) = 'module'                then ash.module
                    when lower(parms.dim) = 'program'               then ash.program
                    when lower(parms.dim) = 'action'                then ash.action
                    when lower(parms.dim) = 'machine'               then ash.machine
                    when lower(parms.dim) = 'event'                 then ash.event
                    when lower(parms.dim) = 'wait_class'            then case when session_state = 'ON CPU'  then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
                    else                                            case when session_state = 'ON CPU'   then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
				end
order by cnt_sid desc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
						
						
						
						
						
						
						null																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																		</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Top SQL]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select distinct
     ash.sql_id
    ,ash.sql_plan_hash_value
    ,count(qc_session_id)           over (partition by ash.sql_id,ash.sql_plan_hash_value) parallel_samples
    ,case	 when count(ash.sql_id) over ()=0 then 0 else trunc(count(ash.sql_id) over (partition by ash.sql_id,ash.sql_plan_hash_value)/count(ash.sql_id) over ()*100) end load_pct_sql
    ,count(distinct sql_exec_id)    over (partition by ash.sql_id,ash.sql_plan_hash_value) executions
    ,count(ash.sql_id)              over (partition by ash.sql_id,ash.sql_plan_hash_value) samples
    ,count(ash.sql_id)              over ()	cnt_tot
    ,nvl((select dbms_lob.substr(sql_fulltext,1000) from gv$sqlstats sqlt where sqlt.sql_id = ash.sql_id and rownum < 2),(select dbms_lob.substr(sql_text,1000) from dba_hist_sqltext hs where hs.sql_id = ash.sql_id and rownum < 2)) sql_fulltext
from ash cross join	parms
where 1=1
	------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
order by load_pct_sql desc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
						
						
						
						
						
						
					null																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																						</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Top SQL by dim]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select distinct
	 :DIM dim
    ,ash.sql_id
    ,ash.sql_plan_hash_value
    ,count(qc_session_id)           over (partition by ash.sql_id,ash.sql_plan_hash_value) parallel_samples
     ,case	 when count(ash.sql_id) over ()=0 then 0 else trunc(count(ash.sql_id) over (partition by ash.sql_id,ash.sql_plan_hash_value)/count(ash.sql_id) over ()*100) end load_pct_sql
    ,count(distinct sql_exec_id)    over (partition by ash.sql_id,ash.sql_plan_hash_value) executions
	,round(sum(ash.time_waited)     over (partition by ash.sql_id,ash.sql_plan_hash_value)/1000)   total_wait_time_ms 
	,round(avg(ash.time_waited)     over (partition by ash.sql_id,ash.sql_plan_hash_value)/1000,2) avg_wait_time_ms 
    ,count(ash.sql_id)              over (partition by ash.sql_id,ash.sql_plan_hash_value) samples
    ,count(ash.sql_id)              over ()	cnt_tot
    ,nvl((select dbms_lob.substr(sql_fulltext,1000) from gv$sqlstats sqlt where sqlt.sql_id = ash.sql_id and rownum < 2),(select dbms_lob.substr(sql_text,1000) from dba_hist_sqltext hs where hs.sql_id = ash.sql_id and rownum < 2)) sql_fulltext
from ash cross join	parms
where 1=1
	------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
    and :DIM =	case
                    when lower(parms.dim) = 'instance_number'       then to_char(ash.instance_number)
                    when lower(parms.dim) = 'user_id'               then to_char(ash.user_id)
                    when lower(parms.dim) = 'session_sid'           then ash.session_id||'.'||ash.session_serial#
                    when lower(parms.dim) = 'xid'                   then rawtohex(ash.xid)
                    when lower(parms.dim) = 'sql_exec_id'           then to_char(ash.sql_exec_id)
                    when lower(parms.dim) = 'sql_exec_id_plan'      then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)
                    when lower(parms.dim) = 'sql_exec_id_plan_oper' then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)||'.'||to_char(ash.sql_plan_line_id)||'.'||ash.sql_plan_operation||'.'||ash.sql_plan_options
                    when lower(parms.dim) = 'sql_id'                then ash.sql_id
                    when lower(parms.dim) = 'current_obj#'          then to_char(ash.current_obj#)
                    when lower(parms.dim) = 'module'                then ash.module
                    when lower(parms.dim) = 'program'               then ash.program
                    when lower(parms.dim) = 'action'                then ash.action
                    when lower(parms.dim) = 'machine'               then ash.machine
                    when lower(parms.dim) = 'event'                 then ash.event
                    when lower(parms.dim) = 'wait_class'            then case when session_state = 'ON CPU'  then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
                    else                                            case when session_state = 'ON CPU'   then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
                end
order by load_pct_sql desc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
						
						
						
						
						
						
					null																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																	</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Top SQL by dim/event]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select distinct
	 :DIM dim
    ,ash.event
    ,ash.sql_id
    ,ash.sql_plan_hash_value
    ,count(qc_session_id)           over (partition by ash.sql_id,ash.sql_plan_hash_value,ash.event) parallel_samples
    ,case	 when count(ash.sql_id) over ()=0 then 0 else trunc(count(ash.sql_id) over (partition by ash.sql_id,ash.sql_plan_hash_value,ash.event)/count(ash.sql_id) over ()*100) end load_pct_sql
    ,count(distinct sql_exec_id)    over (partition by ash.sql_id,ash.sql_plan_hash_value,ash.event) executions
    ,count(ash.sql_id)              over (partition by ash.sql_id,ash.sql_plan_hash_value,ash.event) samples
    ,count(ash.sql_id)              over ()	cnt_tot
    ,nvl((select dbms_lob.substr(sql_fulltext,1000) from gv$sqlstats sqlt where sqlt.sql_id = ash.sql_id and rownum < 2),(select dbms_lob.substr(sql_text,1000) from dba_hist_sqltext hs where hs.sql_id = ash.sql_id and rownum < 2)) sql_fulltext
from ash cross join	parms
where 1=1
	------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
    and :DIM =	case
                    when lower(parms.dim) = 'instance_number'       then to_char(ash.instance_number)
                    when lower(parms.dim) = 'user_id'               then to_char(ash.user_id)
                    when lower(parms.dim) = 'session_sid'           then ash.session_id||'.'||ash.session_serial#
                    when lower(parms.dim) = 'xid'                   then rawtohex(ash.xid)
                    when lower(parms.dim) = 'sql_exec_id'           then to_char(ash.sql_exec_id)
                    when lower(parms.dim) = 'sql_exec_id_plan'      then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)
                    when lower(parms.dim) = 'sql_exec_id_plan_oper' then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)||'.'||to_char(ash.sql_plan_line_id)||'.'||ash.sql_plan_operation||'.'||ash.sql_plan_options
                    when lower(parms.dim) = 'sql_id'                then ash.sql_id
                    when lower(parms.dim) = 'current_obj#'          then to_char(ash.current_obj#)
                    when lower(parms.dim) = 'module'                then ash.module
                    when lower(parms.dim) = 'program'               then ash.program
                    when lower(parms.dim) = 'action'                then ash.action
                    when lower(parms.dim) = 'machine'               then ash.machine
                    when lower(parms.dim) = 'event'                 then ash.event
                    when lower(parms.dim) = 'wait_class'            then case when session_state = 'ON CPU'  then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
                    else                                            case when session_state = 'ON CPU'   then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
                end
order by load_pct_sql desc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
						
						
						
						
						
						
						null																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																		</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Top Objects]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select distinct
	 owner
	,object_name
    ,subobject_name
	,object_type
	,case  when count(obj.object_id) over ()=0 then 0 else trunc(count(obj.object_id) over (partition by obj.object_id)/count(obj.object_id) over ()*100) end load_pct_obj
    ,count(obj.object_id) over (partition by obj.object_id) cnt
    ,count(obj.object_id) over ()                           cnt_tot
    ,'SQLDEV:LINK:'||owner||':'||object_type||':'||object_name||':oracle.dbtools.raptor.controls.grid.DefaultDrillLink' link
from ash
    cross join	parms
    left  outer join dba_objects obj	  on ash.current_obj# = obj.object_id
where 1=1
	------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
order by load_pct_obj desc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
						
						
						
						
						
						
						null																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																		</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Top Objects by dim]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select distinct
	 :DIM dim
    ,owner
	,object_name
    ,subobject_name
	,object_type
	,case  when count(obj.object_id) over ()=0 then 0 else trunc(count(obj.object_id) over (partition by obj.object_id)/count(obj.object_id) over ()*100) end load_pct_obj
    ,count(obj.object_id) over (partition by obj.object_id) cnt
    ,count(obj.object_id) over ()                           cnt_tot
    ,'SQLDEV:LINK:'||owner||':'||object_type||':'||object_name||':oracle.dbtools.raptor.controls.grid.DefaultDrillLink' link
from ash
    cross join	parms
    left  outer join dba_objects obj	  on ash.current_obj# = obj.object_id
where 1=1
	------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
	and :DIM =	case
                    when lower(parms.dim) = 'instance_number'       then to_char(ash.instance_number)
                    when lower(parms.dim) = 'user_id'               then to_char(ash.user_id)
                    when lower(parms.dim) = 'session_sid'           then ash.session_id||'.'||ash.session_serial#
                    when lower(parms.dim) = 'xid'                   then rawtohex(ash.xid)
                    when lower(parms.dim) = 'sql_exec_id'           then to_char(ash.sql_exec_id)
                    when lower(parms.dim) = 'sql_exec_id_plan'      then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)
                    when lower(parms.dim) = 'sql_exec_id_plan_oper' then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)||'.'||to_char(ash.sql_plan_line_id)||'.'||ash.sql_plan_operation||'.'||ash.sql_plan_options
                    when lower(parms.dim) = 'sql_id'                then ash.sql_id
                    when lower(parms.dim) = 'current_obj#'          then to_char(ash.current_obj#)
                    when lower(parms.dim) = 'module'                then ash.module
                    when lower(parms.dim) = 'program'               then ash.program
                    when lower(parms.dim) = 'action'                then ash.action
                    when lower(parms.dim) = 'machine'               then ash.machine
                    when lower(parms.dim) = 'event'                 then ash.event
                    when lower(parms.dim) = 'wait_class'            then case when session_state = 'ON CPU'  then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
                    else                                            case when session_state = 'ON CPU'   then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
				end
order by load_pct_obj desc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
						
						
						
						
						
						
					null																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Top Objects by dim/event]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select distinct
     :DIM dim
    ,ash.event
    ,owner
    ,object_name
    ,subobject_name
    ,object_type
    ,case  when count(obj.object_id)    over ()=0 then 0 else trunc(count(obj.object_id) over (partition by obj.object_id,ash.event)/count(obj.object_id) over ()*100) end load_pct_obj
	,round(sum(ash.time_waited)         over (partition by obj.object_id,ash.event)/1000)   total_wait_time_ms 
	,round(avg(ash.time_waited)         over (partition by obj.object_id,ash.event)/1000,2) avg_wait_time_ms 
    ,count(obj.object_id)               over (partition by obj.object_id,ash.event)         cnt
    ,count(obj.object_id)               over ()                                             cnt_tot
    ,'SQLDEV:LINK:'||owner||':'||object_type||':'||object_name||':oracle.dbtools.raptor.controls.grid.DefaultDrillLink' link
from ash
    cross join	parms
    left  outer join dba_objects obj	  on ash.current_obj# = obj.object_id
where 1=1
	------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
	and :DIM =	case
                    when lower(parms.dim) = 'instance_number'       then to_char(ash.instance_number)
                    when lower(parms.dim) = 'user_id'               then to_char(ash.user_id)
                    when lower(parms.dim) = 'session_sid'           then ash.session_id||'.'||ash.session_serial#
                    when lower(parms.dim) = 'xid'                   then rawtohex(ash.xid)
                    when lower(parms.dim) = 'sql_exec_id'           then to_char(ash.sql_exec_id)
                    when lower(parms.dim) = 'sql_exec_id_plan'      then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)
                    when lower(parms.dim) = 'sql_exec_id_plan_oper' then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)||'.'||to_char(ash.sql_plan_line_id)||'.'||ash.sql_plan_operation||'.'||ash.sql_plan_options
                    when lower(parms.dim) = 'sql_id'                then ash.sql_id
                    when lower(parms.dim) = 'current_obj#'          then to_char(ash.current_obj#)
                    when lower(parms.dim) = 'module'                then ash.module
                    when lower(parms.dim) = 'program'               then ash.program
                    when lower(parms.dim) = 'action'                then ash.action
                    when lower(parms.dim) = 'machine'               then ash.machine
                    when lower(parms.dim) = 'event'                 then ash.event
                    when lower(parms.dim) = 'wait_class'            then case when session_state = 'ON CPU'  then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
                    else                                            case when session_state = 'ON CPU'   then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
				end
order by load_pct_obj desc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
						
						
						
						
						
						
					null																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Top Objects by dim/event/plan]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select distinct
     :DIM dim
    ,ash.event
    ,obj.owner
    ,obj.object_name
    ,obj.subobject_name
    ,obj.object_type
    ,ash.current_obj#
    ,sql_opname
    ,sql_plan_hash_value	
    ,sql_plan_line_id	
    ,sql_plan_operation	
    ,sql_plan_options	
	,round(sum(ash.time_waited)         over (partition by ash.current_obj#,ash.event,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options)/1000)   total_wait_time_ms 
	,round(avg(ash.time_waited)         over (partition by ash.current_obj#,ash.event,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options)/1000,2) avg_wait_time_ms 
    ,count(ash.current_obj#)    over (partition by ash.current_obj#,ash.event,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options) cnt
    ,count(*)                   over ()  cnt_ash
    ,case  when count(*) over ()=0 then 0 else trunc(count(ash.current_obj#) over (partition by ash.current_obj#,ash.event,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options)/count(*) over ()*100) end load_pct
    ,'SQLDEV:LINK:'||owner||':'||object_type||':'||object_name||':oracle.dbtools.raptor.controls.grid.DefaultDrillLink' link
from ash
	left outer join	 dba_objects obj  on ash.current_obj# = obj.object_id
	cross join		 parms
where 1=1
	------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
	and :DIM =	case
                    when lower(parms.dim) = 'instance_number'       then to_char(ash.instance_number)
                    when lower(parms.dim) = 'user_id'               then to_char(ash.user_id)
                    when lower(parms.dim) = 'session_sid'           then ash.session_id||'.'||ash.session_serial#
                    when lower(parms.dim) = 'xid'                   then rawtohex(ash.xid)
                    when lower(parms.dim) = 'sql_exec_id'           then to_char(ash.sql_exec_id)
                    when lower(parms.dim) = 'sql_exec_id_plan'      then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)
                    when lower(parms.dim) = 'sql_exec_id_plan_oper' then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)||'.'||to_char(ash.sql_plan_line_id)||'.'||ash.sql_plan_operation||'.'||ash.sql_plan_options
                    when lower(parms.dim) = 'sql_id'                then ash.sql_id
                    when lower(parms.dim) = 'current_obj#'          then to_char(ash.current_obj#)
                    when lower(parms.dim) = 'module'                then ash.module
                    when lower(parms.dim) = 'program'               then ash.program
                    when lower(parms.dim) = 'action'                then ash.action
                    when lower(parms.dim) = 'machine'               then ash.machine
                    when lower(parms.dim) = 'event'                 then ash.event
                    when lower(parms.dim) = 'wait_class'            then case when session_state = 'ON CPU'  then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
                    else                                            case when session_state = 'ON CPU'   then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
				end
order by load_pct desc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					null																																																																																																																																																																																																																																																																																																																																	</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Top plan line]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select distinct
     ash.sql_id
    ,sql_plan_hash_value	
    ,sql_plan_line_id	
    ,sql_opname
    ,sql_plan_operation	
    ,sql_plan_options
    ,count(qc_session_id)   over (partition by ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options) parallel_samples
    ,count(*)               over (partition by ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options) cnt_plan_line
    ,count(*)               over ()  cnt_ash
    ,count(ash.sample_id)   over ()  cnt_tot
    ,case  when count(*)    over ()=0 then 0 else trunc(count(*) over (partition by ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options)/count(*) over ()*100) end load_pct
    ,count(distinct ash.current_obj#) over (partition by ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options) cnt_objects
    ,max('SQLDEV:LINK:'||owner||':'||object_type||':'||object_name||':oracle.dbtools.raptor.controls.grid.DefaultDrillLink') over (partition by ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options) object
    --,'/*set pages 0 lines 250*/ select * from table(dbms_xplan.display_awr( '''||ash.sql_id||''','''||sql_plan_hash_value||''',null ,''advanced''));'  display_awr
    ,nvl((select dbms_lob.substr(sql_fulltext,1000) from gv$sqlstats sqlt where sqlt.sql_id = ash.sql_id and rownum < 2),(select dbms_lob.substr(sql_text,1000) from dba_hist_sqltext hs where hs.sql_id = ash.sql_id and rownum < 2)) sql_fulltext
from ash
	left outer join	 dba_objects obj  on ash.current_obj# = obj.object_id
	cross join		 parms
where 1=1
	------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
order by load_pct desc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					null																																																																																																																																																																																																																																																																																																																																	</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Top Plan Line by dim]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select distinct
     ash.sql_id
    ,sql_plan_hash_value	
    ,sql_plan_line_id	
    ,sql_opname
    ,sql_plan_operation	
    ,sql_plan_options
    ,count(qc_session_id)   over (partition by ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options) parallel_samples
    ,count(*)               over (partition by ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options) cnt_plan_line
    ,count(*)               over ()  cnt_ash
    ,count(ash.sample_id)   over ()  cnt_tot
    ,case  when count(*)    over ()=0 then 0 else trunc(count(*) over (partition by ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options)/count(*) over ()*100) end load_pct
    ,count(distinct ash.current_obj#) over (partition by ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options) cnt_objects
    ,max('SQLDEV:LINK:'||owner||':'||object_type||':'||object_name||':oracle.dbtools.raptor.controls.grid.DefaultDrillLink') over (partition by ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options) object
    ,nvl((select dbms_lob.substr(sql_fulltext,1000) from gv$sqlstats sqlt where sqlt.sql_id = ash.sql_id and rownum < 2),(select dbms_lob.substr(sql_text,1000) from dba_hist_sqltext hs where hs.sql_id = ash.sql_id and rownum < 2)) sql_fulltext
from ash
	left outer join	 dba_objects obj  on ash.current_obj# = obj.object_id
	cross join		 parms
where 1=1
	------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
	and :DIM =	case
                    when lower(parms.dim) = 'instance_number'       then to_char(ash.instance_number)
                    when lower(parms.dim) = 'user_id'               then to_char(ash.user_id)
                    when lower(parms.dim) = 'session_sid'           then ash.session_id||'.'||ash.session_serial#
                    when lower(parms.dim) = 'xid'                   then rawtohex(ash.xid)
                    when lower(parms.dim) = 'sql_exec_id'           then to_char(ash.sql_exec_id)
                    when lower(parms.dim) = 'sql_exec_id_plan'      then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)
                    when lower(parms.dim) = 'sql_exec_id_plan_oper' then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)||'.'||to_char(ash.sql_plan_line_id)||'.'||ash.sql_plan_operation||'.'||ash.sql_plan_options
                    when lower(parms.dim) = 'sql_id'                then ash.sql_id
                    when lower(parms.dim) = 'current_obj#'          then to_char(ash.current_obj#)
                    when lower(parms.dim) = 'module'                then ash.module
                    when lower(parms.dim) = 'program'               then ash.program
                    when lower(parms.dim) = 'action'                then ash.action
                    when lower(parms.dim) = 'machine'               then ash.machine
                    when lower(parms.dim) = 'event'                 then ash.event
                    when lower(parms.dim) = 'wait_class'            then case when session_state = 'ON CPU'  then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
                    else                                            case when session_state = 'ON CPU'   then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
				end
order by load_pct desc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					null																																																																																																																																																																																																																																																																																																																																	</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Top plan line/object]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select distinct
	 ash.sql_id
    ,sql_plan_hash_value	
    ,sql_plan_line_id	
    ,sql_opname
    ,sql_plan_operation	
    ,sql_plan_options
    ,count(qc_session_id)   over (partition by ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options) parallel_samples
	,obj.owner
	,obj.object_name
	,obj.object_type
    ,count(*)               over (partition by ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options,ash.current_obj#) cnt_plan_line
	,count(*)               over ()  cnt_ash
    ,count(ash.sample_id)   over ()  cnt_tot
	,case  when count(*)    over ()=0 then 0 else trunc(count(*) over (partition by ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options,ash.current_obj#)/count(*) over ()*100) end load_pct
	,'SQLDEV:LINK:'||owner||':'||object_type||':'||object_name||':oracle.dbtools.raptor.controls.grid.DefaultDrillLink' object
    ,nvl((select dbms_lob.substr(sql_fulltext,1000) from gv$sqlstats sqlt where sqlt.sql_id = ash.sql_id and rownum < 2),(select dbms_lob.substr(sql_text,1000) from dba_hist_sqltext hs where hs.sql_id = ash.sql_id and rownum < 2)) sql_fulltext
from ash
	left outer join	 dba_objects obj  on ash.current_obj# = obj.object_id
	cross join		 parms
where 1=1
	------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
order by load_pct desc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					null																																																																																																																																																																																																																																																																																																																																	</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Top plan line/object by dim]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select distinct
	 :DIM
    ,ash.sql_id
    ,sql_plan_hash_value	
    ,sql_plan_line_id	
    ,sql_opname
    ,sql_plan_operation	
    ,sql_plan_options
    ,count(qc_session_id)   over (partition by ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options) parallel_samples
	,obj.owner
	,obj.object_name
    ,obj.subobject_name
	,obj.object_type
    ,count(*) over (partition by :DIM,ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options,ash.current_obj#) cnt_plan_line
	,count(*) over ()  cnt_ash
    ,count(ash.sample_id) over ()  cnt_tot
	,case  when count(*) over ()=0 then 0 else trunc(count(*) over (partition by :DIM,ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options,ash.current_obj#)/count(*) over ()*100) end load_pct
	,'SQLDEV:LINK:'||owner||':'||object_type||':'||object_name||':oracle.dbtools.raptor.controls.grid.DefaultDrillLink' object
    ,nvl((select dbms_lob.substr(sql_fulltext,1000) from gv$sqlstats sqlt where sqlt.sql_id = ash.sql_id and rownum < 2),(select dbms_lob.substr(sql_text,1000) from dba_hist_sqltext hs where hs.sql_id = ash.sql_id and rownum < 2)) sql_fulltext
from ash
	left outer join	 dba_objects obj  on ash.current_obj# = obj.object_id
	cross join		 parms
where 1=1
	------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
	and :DIM =	case
                    when lower(parms.dim) = 'instance_number'       then to_char(ash.instance_number)
                    when lower(parms.dim) = 'user_id'               then to_char(ash.user_id)
                    when lower(parms.dim) = 'session_sid'           then ash.session_id||'.'||ash.session_serial#
                    when lower(parms.dim) = 'xid'                   then rawtohex(ash.xid)
                    when lower(parms.dim) = 'sql_exec_id'           then to_char(ash.sql_exec_id)
                    when lower(parms.dim) = 'sql_exec_id_plan'      then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)
                    when lower(parms.dim) = 'sql_exec_id_plan_oper' then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)||'.'||to_char(ash.sql_plan_line_id)||'.'||ash.sql_plan_operation||'.'||ash.sql_plan_options
                    when lower(parms.dim) = 'sql_id'                then ash.sql_id
                    when lower(parms.dim) = 'current_obj#'          then to_char(ash.current_obj#)
                    when lower(parms.dim) = 'module'                then ash.module
                    when lower(parms.dim) = 'program'               then ash.program
                    when lower(parms.dim) = 'action'                then ash.action
                    when lower(parms.dim) = 'machine'               then ash.machine
                    when lower(parms.dim) = 'event'                 then ash.event
                    when lower(parms.dim) = 'wait_class'            then case when session_state = 'ON CPU'  then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
                    else                                            case when session_state = 'ON CPU'   then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
				end
order by load_pct desc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					null																																																																																																																																																																																																																																																																																																																																	</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
	<display id="null" type="" style="Table" enable="true">
		<name><![CDATA[Top plan line/event by dim]]></name>
		<description><![CDATA[]]></description>
		<tooltip><![CDATA[]]></tooltip>
		<drillclass><![CDATA[]]></drillclass>
		<CustomValues>
			<TYPE><![CDATA[horizontal]]></TYPE>
		</CustomValues>
		<query>
			<sql><![CDATA[with
     parms as ( select nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) start_date ,nvl(to_date(:p_end_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate,'mi')) end_date,nvl(to_number(:p_interval),15) inter,:p_dim dim,:P_INST_ID instance_number,:P_SESSION_SID session_id, :P_SESSION_SERIAL# session_serial#,:P_SQL_ID sql_id,:P_SESSION_TYPE session_type, to_number(:P_USER_ID) user_id,:P_MODULE module, :P_PROGRAM program, :P_MACHINE machine, :P_WAIT_CLASS wait_class, (case when nvl(to_date(:p_start_date,'yyyy-mm-dd hh24:mi'),trunc(sysdate-23/24,'hh')) < sysdate-1 then 10  else 1 end) sample_source from dual)
	,slots as ( select (start_date+(level-1)/24/60/60*inter) as slot from parms connect by (level-1) <= (end_date - start_date)*24*60*60/inter)
	,snaps as ( select snaps.dbid,snaps.instance_number,snaps.snap_id from dba_hist_snapshot snaps cross join parms where not (snaps.begin_interval_time > parms.end_date or snaps.end_interval_time < parms.start_date) and snaps.instance_number = nvl(parms.instance_number, snaps.instance_number))
    ,ash   as ( select ash.snap_id ,ash.dbid ,ash.instance_number ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from dba_hist_active_sess_history ash,(select start_date, end_date, inter, sample_source from parms) p, snaps where snaps.dbid = ash.dbid and snaps.instance_number = ash.instance_number and snaps.snap_id = ash.snap_id and sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 10 then :SLOT else null end union all
                select 0           ,null     ,inst_id             ,sample_id ,sample_time ,session_id ,session_serial# ,session_type ,flags ,user_id ,sql_id ,is_sqlid_current ,sql_child_number ,sql_opcode ,sql_opname ,force_matching_signature ,top_level_sql_id ,top_level_sql_opcode ,sql_plan_hash_value ,sql_plan_line_id ,sql_plan_operation ,sql_plan_options ,sql_exec_id ,sql_exec_start ,plsql_entry_object_id ,plsql_entry_subprogram_id ,plsql_object_id ,plsql_subprogram_id ,qc_instance_id ,qc_session_id ,qc_session_serial# ,px_flags ,event ,event_id ,seq# ,p1text ,p1 ,p2text ,p2 ,p3text ,p3 ,wait_class ,wait_class_id ,wait_time ,session_state ,time_waited ,blocking_session_status ,blocking_session ,blocking_session_serial# ,blocking_inst_id ,blocking_hangchain_info ,current_obj# ,current_file# ,current_block# ,current_row# ,top_level_call# ,top_level_call_name ,consumer_group_id ,xid ,remote_instance# ,time_model ,in_connection_mgmt ,in_parse ,in_hard_parse ,in_sql_execution ,in_plsql_execution ,in_plsql_rpc ,in_plsql_compilation ,in_java_execution ,in_bind ,in_cursor_close ,in_sequence_load ,capture_overhead ,replay_overhead ,is_captured ,is_replayed ,service_hash ,program ,module ,action ,client_id ,machine ,port ,ecid ,dbreplay_file_id ,dbreplay_call_counter ,tm_delta_time ,tm_delta_cpu_time ,tm_delta_db_time ,delta_time ,delta_read_io_requests ,delta_write_io_requests ,delta_read_io_bytes ,delta_write_io_bytes ,delta_interconnect_io_bytes ,pga_allocated ,temp_space_allocated  from gv$active_session_history    ash,(select start_date, end_date, inter, sample_source from parms) p        where                                                                                                           sample_time - mod((cast(sample_time as date) - start_date)*24*60*60,inter)/24/60/60 = case when p.sample_source = 1  then :SLOT else null end)
select distinct
	 :DIM
    ,ash.event
    ,ash.sql_id
    ,sql_plan_hash_value	
    ,sql_plan_line_id	
    ,sql_opname
    ,sql_plan_operation	
    ,sql_plan_options
    ,count(qc_session_id)   over (partition by ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options) parallel_samples
    ,count(*) over (partition by :DIM,ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options,e.name) cnt_plan_line
	,round(sum(ash.time_waited)         over (partition by ash.current_obj#,ash.event,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options)/1000)   total_wait_time_ms 
	,round(avg(ash.time_waited)         over (partition by ash.current_obj#,ash.event,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options)/1000,2) avg_wait_time_ms 
	,count(*) over ()  cnt_ash
    ,count(ash.sample_id) over ()  cnt_tot
	,case  when count(*) over ()=0 then 0 else trunc(count(*) over (partition by :DIM,ash.sql_id,sql_opname,sql_plan_hash_value,sql_plan_line_id,sql_plan_operation,sql_plan_options,e.name)/count(*) over ()*100) end load_pct
    ,nvl((select dbms_lob.substr(sql_fulltext,1000) from gv$sqlstats sqlt where sqlt.sql_id = ash.sql_id and rownum < 2),(select dbms_lob.substr(sql_text,1000) from dba_hist_sqltext hs where hs.sql_id = ash.sql_id and rownum < 2)) sql_fulltext
from ash
    left  outer join v$event_name e		on ash.event_id = e.event_id
	cross join		 parms
where 1=1
	------- additional filters
    and ash.instance_number = nvl(parms.instance_number, ash.instance_number)
    and ash.session_id		= nvl(parms.session_id, ash.session_id)
    and ash.session_serial# = nvl(parms.session_serial#, ash.session_serial#)
    and ((parms.sql_id       is not null and parms.sql_id       = ash.sql_id      )  or  parms.sql_id        is null)
    and ((parms.user_id      is not null and parms.user_id      = ash.user_id     )  or  parms.user_id       is null)  
    and ((parms.session_type is not null and parms.session_type = ash.session_type)  or  parms.session_type  is null)
    and ((parms.module       is not null and parms.module       = ash.module      )  or  parms.module        is null)
    and ((parms.program      is not null and parms.program      = ash.program     )  or  parms.program       is null)
    and ((parms.machine      is not null and parms.machine      = ash.machine     )  or  parms.machine       is null)
    and ((parms.wait_class   is not null and parms.wait_class   = ash.wait_class  )  or  parms.wait_class  is null)
	and :DIM =	case
                    when lower(parms.dim) = 'instance_number'       then to_char(ash.instance_number)
                    when lower(parms.dim) = 'user_id'               then to_char(ash.user_id)
                    when lower(parms.dim) = 'session_sid'           then ash.session_id||'.'||ash.session_serial#
                    when lower(parms.dim) = 'xid'                   then rawtohex(ash.xid)
                    when lower(parms.dim) = 'sql_exec_id'           then to_char(ash.sql_exec_id)
                    when lower(parms.dim) = 'sql_exec_id_plan'      then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)
                    when lower(parms.dim) = 'sql_exec_id_plan_oper' then to_char(ash.sql_exec_id)||'.'||to_char(ash.sql_plan_hash_value)||'.'||to_char(ash.sql_plan_line_id)||'.'||ash.sql_plan_operation||'.'||ash.sql_plan_options
                    when lower(parms.dim) = 'sql_id'                then ash.sql_id
                    when lower(parms.dim) = 'current_obj#'          then to_char(ash.current_obj#)
                    when lower(parms.dim) = 'module'                then ash.module
                    when lower(parms.dim) = 'program'               then ash.program
                    when lower(parms.dim) = 'action'                then ash.action
                    when lower(parms.dim) = 'machine'               then ash.machine
                    when lower(parms.dim) = 'event'                 then ash.event
                    when lower(parms.dim) = 'wait_class'            then case when session_state = 'ON CPU'  then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
                    else                                            case when session_state = 'ON CPU'   then session_state when session_state = 'WAITING' then ash.wait_class else 'WAIT' end
				end
order by load_pct desc]]></sql>
		</query>
			<pdf version="VERSION_1_7" compression="CONTENT">
				<docproperty title="" author="" subject="" keywords="" />
				<cell toppadding="2" bottompadding="2" leftpadding="2" rightpadding="2" horizontalalign="LEFT" verticalalign="TOP" wrap="true" />
				<column>
					<heading font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="FIRST_PAGE" />
					<footing font="null" size="10" style="NORMAL" color="-16777216" rowshading="-1" labeling="NONE" />
					<blob blob="NONE" zip="false" />
				</column>
				<table font="null" size="10" style="NORMAL" color="-16777216" userowshading="false" oddrowshading="-1" evenrowshading="-1" showborders="true" spacingbefore="12" spacingafter="12" horizontalalign="LEFT" />
				<header enable="false" generatedate="false">
					<data>
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
					
						
					
					
					
					
					
					
					
					
					
					
					
					
					
					null																																																																																																																																																																																																																																																																																																			</data>
				</header>
				<footer enable="false" generatedate="false">
					<data value="null" />
				</footer>
				<pagesetup papersize="LETTER" orientation="1" measurement="in" margintop="1.0" marginbottom="1.0" marginleft="1.0" marginright="1.0" />
			</pdf>
	</display>
<item  reload="false"  reloadparent="false" removeFromParent="false" className="oracle.dbtools.raptor.report.addin.DrillReportAction" classArgs="4bbba91e-0142-1000-801a-0b81d15fed85" toolbar="false" ><title>SQL dba_hist</title></item><item  reload="false"  reloadparent="false" removeFromParent="false" className="oracle.dbtools.raptor.report.addin.DrillReportAction" classArgs="2afb4703-014b-1000-800d-0b81d0c8c439" toolbar="false" ><title>SQL gv$</title></item></display>
</displays>
